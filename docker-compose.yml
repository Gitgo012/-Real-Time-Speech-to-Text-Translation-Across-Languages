version: "3.9"

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    env_file:
      - .env  
    environment:
      MONGO_URI: mongodb://host.docker.internal:27017/realtimeASR
    volumes:
      - hf-cache:/models/cache
      - flask-sessions:/app/flask_session
    
#   deploy:
#     resources:
#       reservations:
#         devices:
#           - driver: nvidia
#             count: 1
#             capabilities: [gpu]
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:5000/health', timeout=5).read()",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 120s
    ports:
      - "5000:5000"

  frontend:
    build:
      context: frontend
      dockerfile: Dockerfile
    depends_on:
      backend:
        condition: service_healthy
    ports:
      - "8080:80"

volumes:
  hf-cache:
  flask-sessions:
